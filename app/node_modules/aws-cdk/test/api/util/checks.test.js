"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const AWSMock = require("aws-sdk-mock");
const checks_1 = require("../../../lib/api/util/checks");
describe('determineAllowCrossAccountAssetPublishing', () => {
    let mockSDK;
    beforeEach(() => {
        mockSDK = {
            cloudFormation: () => new AWS.CloudFormation(),
        };
    });
    afterEach(() => {
        AWSMock.restore();
    });
    it('should return true when hasStagingBucket is false', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [{ OutputKey: 'BootstrapVersion', OutputValue: '1' }],
                    }],
            });
        });
        AWSMock.mock('CloudFormation', 'describeStackResources', (_params, callback) => {
            callback(null, { StackResources: [] });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it('should return true when bootstrap version is >= 21', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [{ OutputKey: 'BootstrapVersion', OutputValue: '21' }],
                    }],
            });
        });
        AWSMock.mock('CloudFormation', 'describeStackResources', (_params, callback) => {
            callback(null, { StackResources: [{ ResourceType: 'AWS::S3::Bucket', PhysicalResourceId: 'some-bucket' }] });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(true);
    });
    it('should return false for other scenarios', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [{ OutputKey: 'BootstrapVersion', OutputValue: '20' }],
                    }],
            });
        });
        AWSMock.mock('CloudFormation', 'describeStackResources', (_params, callback) => {
            callback(null, { StackResources: [{ ResourceType: 'AWS::S3::Bucket', PhysicalResourceId: 'some-bucket' }] });
        });
        const result = await (0, checks_1.determineAllowCrossAccountAssetPublishing)(mockSDK);
        expect(result).toBe(false);
    });
});
describe('getBootstrapStackInfo', () => {
    let mockSDK;
    beforeEach(() => {
        mockSDK = {
            cloudFormation: () => new AWS.CloudFormation(),
        };
    });
    afterEach(() => {
        AWSMock.restore();
    });
    it('should return correct BootstrapStackInfo', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [{ OutputKey: 'BootstrapVersion', OutputValue: '21' }],
                    }],
            });
        });
        AWSMock.mock('CloudFormation', 'describeStackResources', (_params, callback) => {
            callback(null, { StackResources: [{ ResourceType: 'AWS::S3::Bucket', PhysicalResourceId: 'some-bucket' }] });
        });
        const result = await (0, checks_1.getBootstrapStackInfo)(mockSDK, 'CDKToolkit');
        expect(result).toEqual({
            hasStagingBucket: true,
            bootstrapVersion: 21,
        });
    });
    it('should throw error when stack is not found', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, { Stacks: [] });
        });
        await expect((0, checks_1.getBootstrapStackInfo)(mockSDK, 'CDKToolkit')).rejects.toThrow('Toolkit stack CDKToolkit not found');
    });
    it('should throw error when BootstrapVersion output is missing', async () => {
        AWSMock.mock('CloudFormation', 'describeStacks', (_params, callback) => {
            callback(null, {
                Stacks: [{
                        Outputs: [],
                    }],
            });
        });
        await expect((0, checks_1.getBootstrapStackInfo)(mockSDK, 'CDKToolkit')).rejects.toThrow('Unable to find BootstrapVersion output in the toolkit stack CDKToolkit');
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaGVja3MudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUMvQix3Q0FBd0M7QUFFeEMseURBQWdIO0FBRWhILFFBQVEsQ0FBQywyQ0FBMkMsRUFBRSxHQUFHLEVBQUU7SUFDekQsSUFBSSxPQUFhLENBQUM7SUFFbEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLE9BQU8sR0FBRztZQUNSLGNBQWMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxjQUFjLEVBQUU7U0FDdkMsQ0FBQztJQUNaLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxtREFBbUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNqRSxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLENBQUMsT0FBWSxFQUFFLFFBQWtCLEVBQUUsRUFBRTtZQUNwRixRQUFRLENBQUMsSUFBSSxFQUFFO2dCQUNiLE1BQU0sRUFBRSxDQUFDO3dCQUNQLE9BQU8sRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsQ0FBQztxQkFDL0QsQ0FBQzthQUNILENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSx3QkFBd0IsRUFBRSxDQUFDLE9BQVksRUFBRSxRQUFrQixFQUFFLEVBQUU7WUFDNUYsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLGNBQWMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFBLGtEQUF5QyxFQUFD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RCxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQzFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFZLEVBQUUsUUFBa0IsRUFBRSxFQUFFO1lBQ3BGLFFBQVEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2IsTUFBTSxFQUFFLENBQUM7d0JBQ1AsT0FBTyxFQUFFLEVBQUU7cUJBQ1osQ0FBQzthQUNILENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxNQUFNLENBQUMsSUFBQSw4QkFBcUIsRUFBQyxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLHdFQUF3RSxDQUFDLENBQUM7SUFDdkosQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIEFXUyBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCAqIGFzIEFXU01vY2sgZnJvbSAnYXdzLXNkay1tb2NrJztcbmltcG9ydCB7IElTREsgfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpL2F3cy1hdXRoJztcbmltcG9ydCB7IGRldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nLCBnZXRCb290c3RyYXBTdGFja0luZm8gfSBmcm9tICcuLi8uLi8uLi9saWIvYXBpL3V0aWwvY2hlY2tzJztcblxuZGVzY3JpYmUoJ2RldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nJywgKCkgPT4ge1xuICBsZXQgbW9ja1NESzogSVNESztcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtb2NrU0RLID0ge1xuICAgICAgY2xvdWRGb3JtYXRpb246ICgpID0+IG5ldyBBV1MuQ2xvdWRGb3JtYXRpb24oKSxcbiAgICB9IGFzIElTREs7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgQVdTTW9jay5yZXN0b3JlKCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgd2hlbiBoYXNTdGFnaW5nQnVja2V0IGlzIGZhbHNlJywgYXN5bmMgKCkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHtcbiAgICAgICAgU3RhY2tzOiBbe1xuICAgICAgICAgIE91dHB1dHM6IFt7IE91dHB1dEtleTogJ0Jvb3RzdHJhcFZlcnNpb24nLCBPdXRwdXRWYWx1ZTogJzEnIH1dLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrUmVzb3VyY2VzJywgKF9wYXJhbXM6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCB7IFN0YWNrUmVzb3VyY2VzOiBbXSB9KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nKG1vY2tTREspO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgd2hlbiBib290c3RyYXAgdmVyc2lvbiBpcyA+PSAyMScsIGFzeW5jICgpID0+IHtcbiAgICBBV1NNb2NrLm1vY2soJ0Nsb3VkRm9ybWF0aW9uJywgJ2Rlc2NyaWJlU3RhY2tzJywgKF9wYXJhbXM6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCB7XG4gICAgICAgIFN0YWNrczogW3tcbiAgICAgICAgICBPdXRwdXRzOiBbeyBPdXRwdXRLZXk6ICdCb290c3RyYXBWZXJzaW9uJywgT3V0cHV0VmFsdWU6ICcyMScgfV0sXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBBV1NNb2NrLm1vY2soJ0Nsb3VkRm9ybWF0aW9uJywgJ2Rlc2NyaWJlU3RhY2tSZXNvdXJjZXMnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHsgU3RhY2tSZXNvdXJjZXM6IFt7IFJlc291cmNlVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcsIFBoeXNpY2FsUmVzb3VyY2VJZDogJ3NvbWUtYnVja2V0JyB9XSB9KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRldGVybWluZUFsbG93Q3Jvc3NBY2NvdW50QXNzZXRQdWJsaXNoaW5nKG1vY2tTREspO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIGZvciBvdGhlciBzY2VuYXJpb3MnLCBhc3luYyAoKSA9PiB7XG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrcycsIChfcGFyYW1zOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgY2FsbGJhY2sobnVsbCwge1xuICAgICAgICBTdGFja3M6IFt7XG4gICAgICAgICAgT3V0cHV0czogW3sgT3V0cHV0S2V5OiAnQm9vdHN0cmFwVmVyc2lvbicsIE91dHB1dFZhbHVlOiAnMjAnIH1dLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgQVdTTW9jay5tb2NrKCdDbG91ZEZvcm1hdGlvbicsICdkZXNjcmliZVN0YWNrUmVzb3VyY2VzJywgKF9wYXJhbXM6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCB7IFN0YWNrUmVzb3VyY2VzOiBbeyBSZXNvdXJjZVR5cGU6ICdBV1M6OlMzOjpCdWNrZXQnLCBQaHlzaWNhbFJlc291cmNlSWQ6ICdzb21lLWJ1Y2tldCcgfV0gfSk7XG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkZXRlcm1pbmVBbGxvd0Nyb3NzQWNjb3VudEFzc2V0UHVibGlzaGluZyhtb2NrU0RLKTtcbiAgICBleHBlY3QocmVzdWx0KS50b0JlKGZhbHNlKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2dldEJvb3RzdHJhcFN0YWNrSW5mbycsICgpID0+IHtcbiAgbGV0IG1vY2tTREs6IElTREs7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbW9ja1NESyA9IHtcbiAgICAgIGNsb3VkRm9ybWF0aW9uOiAoKSA9PiBuZXcgQVdTLkNsb3VkRm9ybWF0aW9uKCksXG4gICAgfSBhcyBJU0RLO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIEFXU01vY2sucmVzdG9yZSgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IEJvb3RzdHJhcFN0YWNrSW5mbycsIGFzeW5jICgpID0+IHtcbiAgICBBV1NNb2NrLm1vY2soJ0Nsb3VkRm9ybWF0aW9uJywgJ2Rlc2NyaWJlU3RhY2tzJywgKF9wYXJhbXM6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICBjYWxsYmFjayhudWxsLCB7XG4gICAgICAgIFN0YWNrczogW3tcbiAgICAgICAgICBPdXRwdXRzOiBbeyBPdXRwdXRLZXk6ICdCb290c3RyYXBWZXJzaW9uJywgT3V0cHV0VmFsdWU6ICcyMScgfV0sXG4gICAgICAgIH1dLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBBV1NNb2NrLm1vY2soJ0Nsb3VkRm9ybWF0aW9uJywgJ2Rlc2NyaWJlU3RhY2tSZXNvdXJjZXMnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHsgU3RhY2tSZXNvdXJjZXM6IFt7IFJlc291cmNlVHlwZTogJ0FXUzo6UzM6OkJ1Y2tldCcsIFBoeXNpY2FsUmVzb3VyY2VJZDogJ3NvbWUtYnVja2V0JyB9XSB9KTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEJvb3RzdHJhcFN0YWNrSW5mbyhtb2NrU0RLLCAnQ0RLVG9vbGtpdCcpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoe1xuICAgICAgaGFzU3RhZ2luZ0J1Y2tldDogdHJ1ZSxcbiAgICAgIGJvb3RzdHJhcFZlcnNpb246IDIxLFxuICAgIH0pO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHRocm93IGVycm9yIHdoZW4gc3RhY2sgaXMgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHsgU3RhY2tzOiBbXSB9KTtcbiAgICB9KTtcblxuICAgIGF3YWl0IGV4cGVjdChnZXRCb290c3RyYXBTdGFja0luZm8obW9ja1NESywgJ0NES1Rvb2xraXQnKSkucmVqZWN0cy50b1Rocm93KCdUb29sa2l0IHN0YWNrIENES1Rvb2xraXQgbm90IGZvdW5kJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiBCb290c3RyYXBWZXJzaW9uIG91dHB1dCBpcyBtaXNzaW5nJywgYXN5bmMgKCkgPT4ge1xuICAgIEFXU01vY2subW9jaygnQ2xvdWRGb3JtYXRpb24nLCAnZGVzY3JpYmVTdGFja3MnLCAoX3BhcmFtczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgIGNhbGxiYWNrKG51bGwsIHtcbiAgICAgICAgU3RhY2tzOiBbe1xuICAgICAgICAgIE91dHB1dHM6IFtdLFxuICAgICAgICB9XSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgYXdhaXQgZXhwZWN0KGdldEJvb3RzdHJhcFN0YWNrSW5mbyhtb2NrU0RLLCAnQ0RLVG9vbGtpdCcpKS5yZWplY3RzLnRvVGhyb3coJ1VuYWJsZSB0byBmaW5kIEJvb3RzdHJhcFZlcnNpb24gb3V0cHV0IGluIHRoZSB0b29sa2l0IHN0YWNrIENES1Rvb2xraXQnKTtcbiAgfSk7XG59KTsiXX0=