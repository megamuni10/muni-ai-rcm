{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CodingAgent API Contract",
  "description": "Input/output schema for the CodingAgent Lambda function",
  
  "definitions": {
    "Patient": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "firstName": { "type": "string" },
        "lastName": { "type": "string" },
        "dateOfBirth": { "type": "string", "format": "date" },
        "gender": { "type": "string", "enum": ["M", "F", "O", "U"] },
        "age": { "type": "integer", "minimum": 0, "maximum": 150 }
      },
      "required": ["id"]
    },
    
    "Encounter": {
      "type": "object",
      "properties": {
        "id": { "type": "string" },
        "visitType": { "type": "string" },
        "dateOfService": { "type": "string", "format": "date" },
        "provider": { "type": "string" },
        "chiefComplaint": { "type": "string" },
        "facilityType": { "type": "string", "enum": ["office", "hospital", "emergency", "urgent_care"] }
      },
      "required": ["id", "dateOfService"]
    },
    
    "CPTCode": {
      "type": "object",
      "properties": {
        "code": { "type": "string", "pattern": "^[0-9]{5}$" },
        "description": { "type": "string" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 100 },
        "reasoning": { "type": "string" }
      },
      "required": ["code", "description", "confidence"]
    },
    
    "ICDCode": {
      "type": "object",
      "properties": {
        "code": { "type": "string", "pattern": "^[A-Z][0-9]{2}(\\.[0-9A-Z]{1,4})?$" },
        "description": { "type": "string" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 100 },
        "reasoning": { "type": "string" }
      },
      "required": ["code", "description", "confidence"]
    }
  },
  
  "input": {
    "type": "object",
    "properties": {
      "patientData": { "$ref": "#/definitions/Patient" },
      "encounterData": { "$ref": "#/definitions/Encounter" },
      "chartNotes": { 
        "type": "string",
        "description": "Clinical documentation and notes"
      },
      "developmentMode": { 
        "type": "boolean",
        "default": true,
        "description": "Whether to use mock data instead of Bedrock"
      }
    },
    "required": ["patientData", "encounterData"]
  },
  
  "output": {
    "type": "object",
    "properties": {
      "success": { "type": "boolean" },
      "cptCodes": {
        "type": "array",
        "items": { "$ref": "#/definitions/CPTCode" }
      },
      "icdCodes": {
        "type": "array",
        "items": { "$ref": "#/definitions/ICDCode" }
      },
      "timestamp": { "type": "string", "format": "date-time" },
      "modelUsed": { "type": "string" },
      "developmentMode": { "type": "boolean" },
      "error": { "type": "string" },
      "requiresManualReview": { "type": "boolean" }
    },
    "required": ["success", "cptCodes", "icdCodes", "timestamp"],
    "additionalProperties": false
  }
}